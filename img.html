<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‹¡ê§ì •ë¹ˆ777ê§‚ - íŒŒì¼ ì—…ë¡œë“œ</title>
<link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,
<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 2000 2000">
  <defs>
    <linearGradient id="linearGradient1" x1="1576.7" y1="1817" x2="423.3" y2="183" gradientUnits="userSpaceOnUse">
      <stop offset="0" stop-color="%233478f6"/>
      <stop offset="1" stop-color="%2353b6f9"/>
    </linearGradient>
    <filter id="filter1" x="0" y="0" width="2000" height="2000" color-interpolation-filters="sRGB">
      <feFlood flood-color="%23000000" flood-opacity="0.52"/>
      <feComposite in2="SourceGraphic" operator="out"/>
      <feGaussianBlur stdDeviation="43"/>
      <feOffset dx="35" dy="24"/>
      <feComposite in2="SourceGraphic" operator="atop"/>
    </filter>
  </defs>
  <path fill="url(%23linearGradient1)" d="M 2000 1000 C 2000 448 1552 0 1000 0 C 448 0 0 448 0 1000 C 0 1552 448 2000 1000 2000 C 1552 2000 2000 1552 2000 1000 Z"/>
  <path fill="%23fff" filter="url(%23filter1)" d="M 1137 506 C 1252 449 1369 497 1427 625 L 1459 696 C 1484 752 1488 821 1471 878 L 1472 877 C 1535 891 1581 939 1608 997 L 1632 1052 C 1698 1199 1657 1324 1544 1381 L 1175 1565 L 972 1114 C 1002 1241 946 1377 834 1433 L 776 1462 C 654 1523 518 1467 449 1343 L 596 1269 C 625 1309 663 1331 708 1308 L 758 1283 C 813 1256 830 1185 802 1124 L 525 509 L 672 435 L 784 683 L 1137 506 Z M 1444 1232 C 1488 1210 1504 1149 1480 1095 L 1476 1085 C 1452 1033 1397 1007 1353 1029 L 1151 1130 L 1242 1333 L 1444 1232 Z M 1184 679 L 991 775 L 1084 981 L 1276 885 C 1319 864 1336 802 1312 749 L 1306 736 C 1283 684 1226 658 1184 679 Z"/>
</svg>' />

<!-- ê³µí†µ í—¤ë” CSS -->
<link rel="stylesheet" href="header.css">

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #ffffff; overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column; }

  main { padding: 0; margin: 0; flex: 1; display: flex; align-items: center; justify-content: center; }

  .container { 
    background:#1a1a1a; 
    padding:40px 20px; 
    border-radius:16px; 
    box-shadow:0 0 30px rgba(0,0,0,0.6); 
    text-align:center; 
    width:90%; 
    max-width:600px; 
    margin: 60px auto;
  }
  h2 { margin-bottom:30px; font-size:28px; color:#3663FF; }

  /* í˜ì´ì§€ ì„¹ì…˜ */
  .page { display:none; }
  .page.active { display:block; }

  /* í˜ì´ì§€ 1: ì—…ë¡œë“œ */
  #uploadSection input[type="file"] { display:none; }
  #dropArea { 
    border:2px dashed #555; 
    border-radius:12px; 
    padding:40px 20px; 
    cursor:pointer; 
    margin-bottom:20px; 
    transition:all 0.3s; 
    background: #2a2a2a;
  }
  #dropArea:hover { 
    border-color:#3663FF; 
    background: #333;
    transform: translateY(-2px);
  }
  #dropArea p { margin:0; color:#aaa; font-size:16px; }
  
  #previewContainer { 
    display:none; 
    max-width:90%; 
    margin:20px auto; 
    text-align:center; 
  }
  #previewImg { 
    max-width:100%; 
    border-radius:10px; 
    box-shadow:0 8px 25px rgba(54,99,255,0.3); 
  }
  .file-icon { 
    font-size:100px; 
    margin:20px 0; 
    animation: fadeIn 0.3s ease-in;
  }
  .file-name { 
    color:#aaa; 
    font-size:14px; 
    margin-top:10px; 
    word-break:break-all; 
    padding: 0 10px;
  }
  .file-size {
    color: #666;
    font-size: 12px;
    margin-top: 5px;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
  }

  .upload-button { 
    background: #3663FF; 
    color:#fff; 
    padding:14px 28px; 
    margin:10px 0; 
    border:none; 
    border-radius:30px; 
    cursor:pointer; 
    font-size:16px; 
    transition:transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
    width:100%; 
  }
  .upload-button:hover { transform:translateY(-8px) scale(1.05); }
  .upload-button:active { background: #2952CC; }

  /* í˜ì´ì§€ 2: ë¡œë”© */
  #loadingSection { text-align:center; padding: 40px 0; }
  .spinner { 
    width:70px; 
    height:70px; 
    border:5px solid rgba(54,99,255,0.2); 
    border-top-color:#3663FF; 
    border-radius:50%; 
    animation:spin 1s linear infinite; 
    margin:30px auto; 
  }
  @keyframes spin { to { transform:rotate(360deg); } }
  #loadingSection p { color:#aaa; font-size:18px; margin-top:20px; }

  /* í˜ì´ì§€ 3: ì™„ë£Œ */
  #completeSection { text-align:center; padding: 20px 0; }
  .check-icon { width:90px; height:90px; margin:20px auto 30px; }
  .check-icon svg { width:100%; height:100%; }
  #completeSection p { color:#3663FF; font-size:22px; font-weight:bold; margin:20px 0 30px; }

  /* ë§í¬ ë³µì‚¬ìš© UI */
  .link-container { display:flex; gap:10px; align-items:center; margin-bottom:15px; }
  #linkDisplay { 
    flex:1; 
    border:2px solid #555; 
    border-radius:8px; 
    padding:12px 16px; 
    background:#2a2a2a; 
    color:#fff; 
    font-size:14px; 
    overflow-x:auto; 
  }
  #copyBtn { 
    min-width:70px; 
    height:45px; 
    padding:0 20px; 
    border-radius:30px; 
    font-size:14px; 
    background: #3663FF; 
    color:#fff; 
    cursor:pointer; 
    border:none;
    transition:transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }
  #copyBtn:hover { transform:translateY(-5px) scale(1.05); }

  @media (max-width: 800px) {
    .container { 
      margin: 30px auto;
      padding: 30px 15px;
    }
    
    h2 { font-size: 24px; }
    .file-icon { font-size: 80px; }
  }
</style>
</head>
<body>

<!-- í—¤ë” ì»¨í…Œì´ë„ˆ -->
<div id="header-container"></div>

<main>
<div class="container">
  <!-- í˜ì´ì§€ 1: ì—…ë¡œë“œ -->
  <div id="uploadSection" class="page active">
    <h2>íŒŒì¼ ì—…ë¡œë“œ</h2>
    <div id="dropArea">
      <p>ğŸ“¤ ì—¬ê¸°ì— íŒŒì¼ ë“œë˜ê·¸ ë˜ëŠ” í´ë¦­</p>
      <input type="file" id="fileInput">
    </div>
    <div id="previewContainer">
      <img id="previewImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°" style="display:none;">
      <div id="fileIcon" style="display:none;">
        <div class="file-icon"></div>
        <div class="file-name"></div>
        <div class="file-size"></div>
      </div>
    </div>
    <button class="upload-button" id="uploadBtn">ì—…ë¡œë“œ</button>
  </div>

  <!-- í˜ì´ì§€ 2: ë¡œë”© -->
  <div id="loadingSection" class="page">
    <h2>ì—…ë¡œë“œ ì¤‘...</h2>
    <div class="spinner"></div>
    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</p>
  </div>

  <!-- í˜ì´ì§€ 3: ì™„ë£Œ -->
  <div id="completeSection" class="page">
    <h2>ì—…ë¡œë“œ ì™„ë£Œ</h2>
    <div class="check-icon">
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="45" fill="none" stroke="#3663FF" stroke-width="4"/>
        <path d="M 30 50 L 45 65 L 70 35" fill="none" stroke="#3663FF" stroke-width="6" stroke-linecap="round" stroke-linejoin="round">
          <animate attributeName="stroke-dasharray" from="0 100" to="100 100" dur="0.5s" fill="freeze"/>
          <animate attributeName="stroke-dashoffset" from="100" to="0" dur="0.5s" fill="freeze"/>
        </path>
      </svg>
    </div>
    <p>ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</p>
    <div class="link-container">
      <input id="linkDisplay" type="text" readonly>
      <button id="copyBtn">ë³µì‚¬</button>
    </div>
    <button class="upload-button" id="openPreviewBtn">ë¯¸ë¦¬ë³´ê¸° ì—´ê¸°</button>
    <button class="upload-button" id="newUploadBtn">ìƒˆë¡œ ì—…ë¡œë“œ</button>
  </div>
</div>
</main>

<!-- ê³µí†µ í—¤ë” JavaScript -->
<script src="header.js"></script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyB8OHhR0Vjan_nNdCczb5e2bOuDBYYRiIg",
  authDomain: "urlshare-718c1.firebaseapp.com",
  databaseURL: "https://urlshare-718c1-default-rtdb.firebaseio.com",
  projectId: "urlshare-718c1",
  storageBucket: "urlshare-718c1.firebasestorage.app",
  messagingSenderId: "666729308999",
  appId: "1:666729308999:web:a7f6d363e88b1d5ed5a262",
  measurementId: "G-VZH9BNQ3VR"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

// ì§§ì€ ì½”ë“œ ìƒì„± í•¨ìˆ˜
function generateShortCode() {
  const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// ë§í¬ ë‹¨ì¶• í•¨ìˆ˜
async function shortenUrl(longUrl) {
  const shortCode = generateShortCode();
  const shortUrl = `${location.origin}/view.html?s=${shortCode}`;
  
  try {
    // Firebaseì— ì €ì¥
    await set(ref(database, 'urls/' + shortCode), {
      longUrl: longUrl,
      created: Date.now()
    });
    
    return shortUrl;
  } catch (error) {
    console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
    throw error;
  }
}

// ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
window.shortenUrl = shortenUrl;
</script>

<script>
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const previewContainer = document.getElementById('previewContainer');
const previewImg = document.getElementById('previewImg');
const fileIcon = document.getElementById('fileIcon');
const uploadBtn = document.getElementById('uploadBtn');
const copyBtn = document.getElementById('copyBtn');
const linkDisplay = document.getElementById('linkDisplay');
const openPreviewBtn = document.getElementById('openPreviewBtn');
const newUploadBtn = document.getElementById('newUploadBtn');

// PDF íŒŒì¼ ì²´í¬ í•¨ìˆ˜
function isPDF(file) {
  const fileName = file.name.toLowerCase();
  return fileName.endsWith('.pdf') || file.type === 'application/pdf';
}

// íŒŒì¼ íƒ€ì…ë³„ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
function getFileIcon(fileName) {
  const ext = fileName.split('.').pop().toLowerCase();
  const icons = {
    // ë¬¸ì„œ
    'doc': 'ğŸ“', 'docx': 'ğŸ“',
    'txt': 'ğŸ“ƒ',
    'rtf': 'ğŸ“ƒ',
    // ìŠ¤í”„ë ˆë“œì‹œíŠ¸
    'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š',
    'csv': 'ğŸ“Š',
    // í”„ë ˆì  í…Œì´ì…˜
    'ppt': 'ğŸ“½ï¸', 'pptx': 'ğŸ“½ï¸',
    // ì••ì¶•íŒŒì¼
    'zip': 'ğŸ—œï¸', 'rar': 'ğŸ—œï¸', '7z': 'ğŸ—œï¸',
    'tar': 'ğŸ—œï¸', 'gz': 'ğŸ—œï¸',
    // ë™ì˜ìƒ
    'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬', 'mkv': 'ğŸ¬', 'webm': 'ğŸ¬',
    'flv': 'ğŸ¬', 'wmv': 'ğŸ¬',
    // ìŒì•…
    'mp3': 'ğŸµ', 'wav': 'ğŸµ', 'flac': 'ğŸµ', 'm4a': 'ğŸµ',
    'ogg': 'ğŸµ', 'aac': 'ğŸµ',
    // ì½”ë“œ
    'html': 'ğŸ’»', 'css': 'ğŸ’»', 'js': 'ğŸ’»', 'py': 'ğŸ’»', 'java': 'ğŸ’»',
    'cpp': 'ğŸ’»', 'c': 'ğŸ’»', 'php': 'ğŸ’»', 'json': 'ğŸ’»',
    'xml': 'ğŸ’»', 'sql': 'ğŸ’»', 'sh': 'ğŸ’»',
    // ì´ë¯¸ì§€
    'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
    'bmp': 'ğŸ–¼ï¸', 'svg': 'ğŸ–¼ï¸', 'webp': 'ğŸ–¼ï¸', 'heic': 'ğŸ–¼ï¸', 
    'heif': 'ğŸ–¼ï¸', 'tiff': 'ğŸ–¼ï¸', 'tif': 'ğŸ–¼ï¸',
  };
  return icons[ext] || 'ğŸ“';
}

// íŒŒì¼ í¬ê¸° í¬ë§·
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// í˜ì´ì§€ ì „í™˜ í•¨ìˆ˜
function showPage(pageName) {
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
  document.getElementById(pageName + 'Section').classList.add('active');
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­
dropArea.addEventListener('click', () => fileInput.click());
dropArea.addEventListener('dragover', e => { 
  e.preventDefault(); 
  dropArea.style.borderColor = '#3663FF'; 
});
dropArea.addEventListener('dragleave', e => { 
  e.preventDefault(); 
  dropArea.style.borderColor = '#555'; 
});
dropArea.addEventListener('drop', async e => {
  e.preventDefault(); 
  dropArea.style.borderColor = '#555';
  if(e.dataTransfer.files.length) {
    const file = e.dataTransfer.files[0];
    if(isPDF(file)) {
      alert('âš ï¸ PDF íŒŒì¼ì€ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    fileInput.files = e.dataTransfer.files; 
    previewFile(file); 
  }
});

fileInput.addEventListener('change', () => { 
  if(fileInput.files.length) {
    const file = fileInput.files[0];
    if(isPDF(file)) {
      alert('âš ï¸ PDF íŒŒì¼ì€ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      fileInput.value = '';
      return;
    }
    previewFile(file); 
  }
});

function previewFile(file) {
  previewContainer.style.display = 'block';
  
  // ë¸Œë¼ìš°ì €ì—ì„œ ë¯¸ë¦¬ë³´ê¸° ê°€ëŠ¥í•œ ì´ë¯¸ì§€ í¬ë§·ë§Œ ì²´í¬
  const fileName = file.name.toLowerCase();
  const previewableImages = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'ico'];
  const canPreview = (file.type.startsWith('image/') && !fileName.endsWith('.heic') && !fileName.endsWith('.heif')) 
                     || previewableImages.some(ext => fileName.endsWith('.' + ext));
  
  if (canPreview) {
    const reader = new FileReader();
    reader.onload = ev => { 
      previewImg.src = ev.target.result; 
      previewImg.style.display = 'block'; 
      fileIcon.style.display = 'none';
    };
    reader.readAsDataURL(file);
  } else {
    // ë¯¸ë¦¬ë³´ê¸° ë¶ˆê°€ëŠ¥í•œ íŒŒì¼ì€ ì•„ì´ì½˜ í‘œì‹œ
    previewImg.style.display = 'none';
    fileIcon.style.display = 'block';
    fileIcon.querySelector('.file-icon').textContent = getFileIcon(file.name);
    fileIcon.querySelector('.file-name').textContent = file.name;
    fileIcon.querySelector('.file-size').textContent = formatFileSize(file.size);
  }
}

// ì—…ë¡œë“œ ë²„íŠ¼
uploadBtn.addEventListener('click', async () => {
  const file = fileInput.files[0];
  if(!file) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!');
  
  // PDF ì²´í¬
  if(isPDF(file)) {
    alert('âš ï¸ PDF íŒŒì¼ì€ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  // í˜ì´ì§€ 2ë¡œ ì „í™˜ (ë¡œë”©)
  showPage('loading');

  const cloudName = 'dretlhsrk';
  const uploadPreset = 'unsigned_preset';
  
  // íŒŒì¼ íƒ€ì…ì— ë”°ë¼ ì—…ë¡œë“œ ì—”ë“œí¬ì¸íŠ¸ ê²°ì •
  let resourceType = 'auto';
  if (file.type.startsWith('video/')) {
    resourceType = 'video';
  } else if (file.type.startsWith('image/')) {
    resourceType = 'image';
  } else {
    resourceType = 'raw';
  }
  
  const url = `https://api.cloudinary.com/v1_1/${cloudName}/${resourceType}/upload`;
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', uploadPreset);

  try {
    const res = await fetch(url, {method: 'POST', body: formData});
    const data = await res.json();
    
    if(data.secure_url) {
      const previewUrl = `${location.origin}/view.html?img=${encodeURIComponent(data.secure_url)}`;
      
      // Firebaseë¡œ ë§í¬ ë‹¨ì¶•
      try {
        const shortUrl = await window.shortenUrl(previewUrl);
        linkDisplay.value = shortUrl;
        
        // ë³µì‚¬ ë²„íŠ¼
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(shortUrl).then(() => {
            const originalText = copyBtn.textContent;
            copyBtn.textContent = "âœ”";
            copyBtn.style.background = "#00cc88";
            setTimeout(() => {
              copyBtn.textContent = originalText;
              copyBtn.style.background = "#3663FF";
            }, 1500);
          });
        };

        openPreviewBtn.onclick = () => window.open(shortUrl, '_blank');
      } catch(err) {
        // ë‹¨ì¶• ì‹¤íŒ¨ ì‹œ ì›ë³¸ URL ì‚¬ìš©
        console.error('ë§í¬ ë‹¨ì¶• ì‹¤íŒ¨:', err);
        linkDisplay.value = previewUrl;
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(previewUrl).then(() => {
            const originalText = copyBtn.textContent;
            copyBtn.textContent = "âœ”";
            copyBtn.style.background = "#00cc88";
            setTimeout(() => {
              copyBtn.textContent = originalText;
              copyBtn.style.background = "#3663FF";
            }, 1500);
          });
        };
        openPreviewBtn.onclick = () => window.open(previewUrl, '_blank');
      }

      // í˜ì´ì§€ 3ìœ¼ë¡œ ì „í™˜ (ì™„ë£Œ)
      showPage('complete');
    } else {
      throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
    }
  } catch(e) {
    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
    showPage('upload');
  }
});

// ìƒˆë¡œ ì—…ë¡œë“œ ë²„íŠ¼
newUploadBtn.addEventListener('click', () => {
  fileInput.value = '';
  previewContainer.style.display = 'none';
  previewImg.style.display = 'none';
  previewImg.src = '';
  fileIcon.style.display = 'none';
  linkDisplay.value = '';
  showPage('upload');
});
</script>
</body>
</html>
