<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Local AI Chat (Groq)</title>
<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #f0f0f0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #chat {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
  }
  .msg {
    max-width: 70%;
    padding: 10px 14px;
    margin: 8px 0;
    border-radius: 12px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .user {
    background: #4f46e5;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }
  .ai {
    background: white;
    color: black;
    margin-right: auto;
    border-bottom-left-radius: 4px;
  }
  #inputBox {
    display: flex;
    padding: 10px;
    background: white;
    border-top: 1px solid #ddd;
  }
  input {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  button {
    margin-left: 8px;
    padding: 10px 16px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    background: #4f46e5;
    color: white;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="chat"></div>

<div id="inputBox">
  <input
    id="msg"
    placeholder="메시지를 입력하세요"
    oncompositionstart="isComposing = true"
    oncompositionend="isComposing = false"
    onkeydown="handleKey(event)"
  >
  <button onclick="send()">전송</button>
</div>

<script>
/* ⚠️ 로컬 테스트용 API 키 */
const GROQ_API_KEY = "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";

/* 한글 IME 조합 상태 */
let isComposing = false;

const chat = document.getElementById("chat");

/* 메시지 추가 */
function addMessage(text, type) {
  const div = document.createElement("div");
  div.className = "msg " + type;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* Enter 처리 (한글 중복 방지 핵심) */
function handleKey(e) {
  if (e.key === "Enter" && !isComposing) {
    e.preventDefault();
    send();
  }
}

/* 메시지 전송 */
async function send() {
  const input = document.getElementById("msg");
  const message = input.value.trim();
  if (!message) return;

  // 1️⃣ 사용자 메시지 즉시 표시
  addMessage(message, "user");
  input.value = "";

  try {
    // 2️⃣ Groq API 호출
    const res = await fetch(
      "https://api.groq.com/openai/v1/chat/completions",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${GROQ_API_KEY}`
        },
        body: JSON.stringify({
          model: "llama-3.1-8b-instant",
          messages: [
            { role: "system", content: "너는 친절한 대화형 AI야." },
            { role: "user", content: message }
          ]
        })
      }
    );

    const data = await res.json();

    if (data.error) {
      addMessage("❌ 오류: " + data.error.message, "ai");
      return;
    }

    // 3️⃣ AI 답변 표시
    addMessage(data.choices[0].message.content, "ai");

  } catch (err) {
    addMessage("❌ 네트워크 오류", "ai");
  }
}
</script>

</body>
</html>
